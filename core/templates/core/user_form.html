{% extends 'core/base.html' %}

{% block title %}{% if usuario %}Editar{% else %}Novo{% endif %} Usu√°rio - Controle de Acesso{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">{% if usuario %}Editar{% else %}Novo{% endif %} Usu√°rio</h5>
            </div>
            <div class="card-body">
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    {% if not usuario %}
                    <!-- Campos espec√≠ficos para novo usu√°rio -->
                    <div class="mb-3">
                        <label class="form-label">Nome de Usu√°rio*</label>
                        <input type="text" name="username" class="form-control" required>
                        <div class="invalid-feedback">
                            Por favor, informe um nome de usu√°rio.
                        </div>
                        <div class="form-text">
                            O nome de usu√°rio ser√° usado para fazer login no sistema.
                            A senha tempor√°ria ser√° gerada no formato: <strong>usuario@1234</strong> (n√∫meros aleat√≥rios).
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if usuario %}
                    <!-- Campos espec√≠ficos para edi√ß√£o -->
                    <div class="mb-3">
                        <label class="form-label">Nome de Usu√°rio</label>
                        <input type="text" name="username" class="form-control" value="{{ usuario.username }}" readonly>
                        <div class="form-text">
                            O nome de usu√°rio n√£o pode ser alterado.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" name="redefinir_senha" class="form-check-input" id="redefinir_senha">
                            <label class="form-check-label" for="redefinir_senha">
                                Redefinir senha do usu√°rio
                            </label>
                            <div class="form-text">
                                Marque esta op√ß√£o para gerar uma nova senha tempor√°ria. 
                                O usu√°rio ser√° obrigado a trocar a senha no pr√≥ximo login.
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" name="forcar_troca" class="form-check-input" id="forcar_troca">
                            <label class="form-check-label" for="forcar_troca">
                                For√ßar troca de senha no pr√≥ximo login
                            </label>
                            <div class="form-text">
                                Marque esta op√ß√£o para for√ßar o usu√°rio a trocar sua senha atual 
                                no pr√≥ximo login, sem redefinir a senha atual.
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">E-mail (opcional)</label>
                        <input type="email" name="email" class="form-control" value="{{ usuario.email|default:'' }}">
                    </div>
                    {% endif %}
                    
                    <!-- Campos comuns -->
                    <div class="mb-3">
                        <label class="form-label">Nome*</label>
                        <input type="text" name="first_name" class="form-control" value="{{ usuario.first_name|default:'' }}" required>
                        <div class="invalid-feedback">
                            Por favor, informe o nome.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Sobrenome*</label>
                        <input type="text" name="last_name" class="form-control" value="{{ usuario.last_name|default:'' }}" required>
                        <div class="invalid-feedback">
                            Por favor, informe o sobrenome.
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">Tipo de Usu√°rio*</label>
                        <div class="form-check">
                            <input type="radio" name="tipo_usuario" value="OPERADOR" class="form-check-input" id="tipo_operador" 
                                   {% if not usuario or usuario.perfil.tipo_usuario == 'OPERADOR' %}checked{% endif %}>
                            <label class="form-check-label" for="tipo_operador">
                                <strong>üîß Operador</strong> - Acesso completo em ambos os ambientes
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="radio" name="tipo_usuario" value="VISUALIZACAO" class="form-check-input" id="tipo_visualizacao"
                                   {% if usuario and usuario.perfil.tipo_usuario == 'VISUALIZACAO' %}checked{% endif %}>
                            <label class="form-check-label" for="tipo_visualizacao">
                                <strong>üëÅÔ∏è Visualiza√ß√£o</strong> - Apenas visualizar, retirar faltas e exportar no ambiente de produ√ß√£o
                            </label>
                        </div>
                        <div class="form-check">
                            <input type="radio" name="tipo_usuario" value="STAFF" class="form-check-input" id="tipo_staff"
                                   {% if usuario and usuario.perfil.tipo_usuario == 'STAFF' or usuario.is_staff %}checked{% endif %}>
                            <label class="form-check-label" for="tipo_staff">
                                <strong>üë§ Staff</strong> - Acesso administrativo + permiss√µes de operador
                            </label>
                        </div>
                        <div class="form-text">
                            <strong>Operador:</strong> Pode registrar acessos, excluir, limpar dashboard em ambos ambientes.<br>
                            <strong>Visualiza√ß√£o:</strong> No ambiente de produ√ß√£o apenas visualiza, retira faltas e exporta Excel. No treinamento tem acesso completo.<br>
                            <strong>Staff:</strong> Pode gerenciar usu√°rios, acessar hist√≥rico e tem todas as permiss√µes de operador.
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end gap-2">
                        <a href="{% url 'user_list' %}" class="btn btn-secondary">Cancelar</a>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Valida√ß√£o do formul√°rio
(function () {
    'use strict'
    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
            }
            form.classList.add('was-validated')
        }, false)
    })
    
    // L√≥gica para redefinir senha e for√ßar troca
    if (document.getElementById('redefinir_senha')) {
        document.getElementById('redefinir_senha').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('forcar_troca').checked = true;
                document.getElementById('forcar_troca').disabled = true;
            } else {
                document.getElementById('forcar_troca').disabled = false;
            }
        });
    }
})()
</script>
{% endblock %}
{% endblock %} 