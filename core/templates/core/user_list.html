{% extends 'core/base.html' %}

{% block title %}Usu√°rios - Controle de Acesso{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Usu√°rios do Sistema</h5>
                        <a href="{% url 'user_create' %}" class="btn btn-primary">
                    <i class="bi bi-person-plus"></i> Novo Usu√°rio
                </a>
    </div>
    <div class="card-body">
        {% csrf_token %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Usu√°rio</th>
                        <th>Nome</th>
                        <th>Tipo</th>
                        <th>Status da Senha</th>
                        <th>Senha Atual</th>
                        <th>√öltimo Acesso</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in users_data %}
                    <tr>
                        <td>{{ data.user.username }}</td>
                        <td>{{ data.user.get_full_name }}</td>
                        <td>
                            {% if data.user.is_superuser %}
                            <span class="badge bg-danger">üîë Administrador</span>
                            {% elif data.perfil.tipo_usuario == 'STAFF' %}
                            <span class="badge bg-warning text-dark">üë§ Staff</span>
                            {% elif data.perfil.tipo_usuario == 'VISUALIZACAO' %}
                            <span class="badge bg-info">üëÅÔ∏è Visualiza√ß√£o</span>
                            {% else %}
                            <span class="badge bg-primary">üîß Operador</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if data.perfil.tipo_usuario == 'VISUALIZACAO' %}
                            <div class="d-flex align-items-center">
                                <span class="badge bg-info me-2">
                                    <i class="bi bi-eye me-1"></i>
                                    Sempre Vis√≠vel
                                </span>
                                <small class="text-muted">Visualiza√ß√£o</small>
                            </div>
                            {% elif data.perfil.precisa_trocar_senha %}
                            <div class="d-flex align-items-center">
                                <span class="badge bg-warning text-dark me-2">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    Tempor√°ria
                                </span>
                                <small class="text-muted">Troca pendente</small>
                            </div>
                            {% else %}
                            <div class="d-flex align-items-center">
                                <span class="badge bg-success me-2">
                                    <i class="bi bi-check-circle me-1"></i>
                                    Definitiva
                                </span>
                                <small class="text-muted">{{ data.perfil.data_atualizacao|date:"d/m/Y H:i"|default:"Sem data" }}</small>
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            {% if data.senha_temporaria %}
                            <div class="d-flex align-items-center">
                                <code class="me-2">{{ data.senha_temporaria }}</code>
                                <button class="btn btn-sm btn-outline-secondary" 
                                        onclick="copiarSenha('{{ data.senha_temporaria }}')"
                                        title="Copiar senha">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                                {% if data.perfil.tipo_usuario == 'VISUALIZACAO' %}
                                <small class="text-info ms-2">
                                    <i class="bi bi-eye" title="Senha sempre vis√≠vel para usu√°rios de visualiza√ß√£o"></i>
                                </small>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if data.user.last_login %}
                            <div class="d-flex flex-column">
                                <span>{{ data.user.last_login|date:"d/m/Y" }}</span>
                                <small class="text-muted">{{ data.user.last_login|date:"H:i" }}</small>
                            </div>
                            {% else %}
                            <span class="text-muted">Nunca acessou</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="{% url 'user_update' data.user.id %}" class="btn btn-sm btn-primary" title="Editar usu√°rio">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                
                                {% if is_superuser and not data.user.is_superuser %}
                                <button type="button" class="btn btn-sm btn-warning" 
                                        title="Redefinir senha" 
                                        onclick="redefinirSenha({{ data.user.id }}, '{{ data.user.username }}', '{{ data.senha_temporaria }}')">
                                    <i class="bi bi-key"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-info" 
                                        title="For√ßar troca de senha" 
                                        onclick="forcarTrocaSenha({{ data.user.id }}, '{{ data.user.username }}')">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                                {% endif %}
                                
                                {% if not data.user.is_superuser %}
                                <button type="button" class="btn btn-sm btn-danger" 
                                        title="Excluir usu√°rio"
                                        onclick="excluirUsuario({{ data.user.id }}, '{{ data.user.username }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center">Nenhum usu√°rio cadastrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
function copiarSenha(senha) {
    navigator.clipboard.writeText(senha).then(() => {
        Swal.fire({
            title: 'Senha copiada!',
            text: 'A senha tempor√°ria foi copiada para a √°rea de transfer√™ncia.',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        });
    });
}

function excluirUsuario(userId, username) {
    if (confirm(`Tem certeza que deseja excluir o usu√°rio "${username}"?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/usuarios/${userId}/excluir/`;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

function redefinirSenha(userId, username, senhaSugerida) {
    // Verifica se √© um usu√°rio de visualiza√ß√£o pela presen√ßa do √≠cone de olho
    const row = document.querySelector(`button[onclick*="redefinirSenha(${userId}"]`).closest('tr');
    const isVisualizacao = row.querySelector('.bi-eye[title*="visualiza√ß√£o"]') !== null;
    
    const titulo = isVisualizacao ? 
        `Gerar nova senha para "${username}"` : 
        `Redefinir senha de "${username}"`;
        
    const texto = isVisualizacao ?
        `<p>Voc√™ deseja gerar uma nova senha para este usu√°rio de visualiza√ß√£o?</p>
         <p>A nova senha ser√°: <strong>${senhaSugerida}</strong></p>
         <p class="text-info">A senha ficar√° sempre vis√≠vel na lista de usu√°rios.</p>` :
        `<p>Voc√™ deseja redefinir a senha deste usu√°rio?</p>
         <p>A senha tempor√°ria ser√°: <strong>${senhaSugerida}</strong></p>
         <p class="text-warning">O usu√°rio precisar√° trocar esta senha no pr√≥ximo login.</p>`;
    
    Swal.fire({
        title: titulo,
        html: texto,
        icon: isVisualizacao ? 'info' : 'warning',
        showCancelButton: true,
        confirmButtonText: isVisualizacao ? 'Gerar Nova Senha' : 'Redefinir',
        cancelButtonText: 'Cancelar',
    }).then((result) => {
        if (result.isConfirmed) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `{% url 'user_reset_password' 0 %}`.replace('0', userId);
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            form.appendChild(csrfInput);
            
            // Adiciona campos necess√°rios para redefinir a senha
            const tempPwd = document.createElement('input');
            tempPwd.type = 'hidden';
            tempPwd.name = 'redefinir_senha';
            tempPwd.value = 'on';
            form.appendChild(tempPwd);
            
            document.body.appendChild(form);
            form.submit();
        }
    });
}

function forcarTrocaSenha(userId, username) {
    Swal.fire({
        title: `For√ßar troca de senha de "${username}"`,
        html: `
            <p>Voc√™ deseja for√ßar este usu√°rio a trocar sua senha atual no pr√≥ximo login?</p>
            <p>A senha atual continuar√° funcionando at√© que o usu√°rio efetue a troca.</p>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'For√ßar Troca',
        cancelButtonText: 'Cancelar',
    }).then((result) => {
        if (result.isConfirmed) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `{% url 'user_reset_password' 0 %}`.replace('0', userId);
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            form.appendChild(csrfInput);
            
            // Adiciona campos necess√°rios para for√ßar troca de senha
            const forceTroca = document.createElement('input');
            forceTroca.type = 'hidden';
            forceTroca.name = 'forcar_troca';
            forceTroca.value = 'on';
            form.appendChild(forceTroca);
            
            document.body.appendChild(form);
            form.submit();
        }
    });
}
</script>
{% endblock %} 